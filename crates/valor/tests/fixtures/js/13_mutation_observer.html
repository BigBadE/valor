<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MutationObserver Basic</title>
  <style> html, body { margin:0; padding:0; } </style>
</head>
<body>
  <div id="root"><span id="a">A</span></div>
  <script>
    window._valorRun = async function() {
      try {
        const root = document.getElementById('root');
        const records = [];
        const mo = new MutationObserver(list => { records.push(...list); });
        mo.observe(root, { childList: true, subtree: true, attributes: true, characterData: true });
        // Mutations
        const a = document.getElementById('a');
        a.textContent = 'AA';                 // characterData mutation
        const b = document.createElement('b');
        b.id = 'b';
        root.appendChild(b);                  // childList add
        b.setAttribute('data-x', '1');        // attributes
        // Allow microtask checkpoint
        await Promise.resolve();
        await new Promise(r => setTimeout(r, 0));
        _valorAssert('some mutations observed', records.length >= 3, 'len='+records.length);
        const types = records.map(r => r.type).sort().join(',');
        _valorAssert('contains childList', types.includes('childList'), types);
        _valorAssert('contains attributes', types.includes('attributes'), types);
        _valorAssert('contains characterData', types.includes('characterData'), types);
        mo.disconnect();
      } catch (e) {
        _valorAssert('mutation-observer-exception', false, String(e && e.stack || e));
      }
    };
  </script>
</body>
</html>
