<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Events Propagation Order</title>
  <style>
    html, body { margin: 0; padding: 0; }
    #outer { padding: 8px; background: #eee; }
    #mid { padding: 8px; background: #ddf; }
    #btn { width: 80px; height: 30px; }
  </style>
</head>
<body>
  <div id="outer"><div id="mid"><button id="btn">Go</button></div></div>
  <script>
    window._valorRun = function() {
      try {
        const log = [];
        const rec = (s) => log.push(s);
        const outer = document.getElementById('outer');
        const mid = document.getElementById('mid');
        const btn = document.getElementById('btn');

        // capture listeners fire from outer to target
        outer.addEventListener('click', () => rec('capture:outer'), true);
        mid.addEventListener('click', () => rec('capture:mid'), true);
        btn.addEventListener('click', () => rec('capture:btn'), true);

        // bubble listeners fire from target to outer
        btn.addEventListener('click', () => rec('bubble:btn'));
        mid.addEventListener('click', () => rec('bubble:mid'));
        outer.addEventListener('click', () => rec('bubble:outer'));

        // stopImmediatePropagation at target bubble should block further target/bubble listeners on same phase
        btn.addEventListener('click', (e) => { rec('bubble:btn:immediate1'); e.stopImmediatePropagation(); });
        btn.addEventListener('click', () => rec('bubble:btn:immediate2'));

        const ev = new MouseEvent('click', { bubbles: true, cancelable: true });
        btn.dispatchEvent(ev);

        // assertions
        const s = log.join(',');
        // capture order
        _valorAssert('capture outer before mid', s.indexOf('capture:outer') < s.indexOf('capture:mid'), s);
        _valorAssert('capture mid before btn', s.indexOf('capture:mid') < s.indexOf('capture:btn'), s);
        // target capture before bubble
        _valorAssert('btn capture before btn bubble', s.indexOf('capture:btn') < s.indexOf('bubble:btn'), s);
        // stopImmediatePropagation: second target bubble listener not invoked
        _valorAssert('stopImmediatePropagation blocked later target listeners', s.indexOf('bubble:btn:immediate2') === -1, s);
        // bubble order
        _valorAssert('bubble btn before mid', s.indexOf('bubble:btn') < s.indexOf('bubble:mid'), s);
        _valorAssert('bubble mid before outer', s.indexOf('bubble:mid') < s.indexOf('bubble:outer'), s);
      } catch (e) {
        _valorAssert('events-propagation-exception', false, String(e && e.stack || e));
      }
    };
  </script>
</body>
</html>
