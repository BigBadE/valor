<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Fetch Mock</title>
  <style> html, body { margin:0; padding:0; } </style>
</head>
<body>
  <script>
    window._valorRun = async function() {
      try {
        // Mock fetch deterministically
        const origFetch = window.fetch;
        window.fetch = async function(url, opts) {
          return {
            ok: true,
            status: 200,
            json: async () => ({ url: String(url), method: (opts && opts.method) || 'GET', ok: true }),
            text: async () => 'ok',
          };
        };
        const res = await fetch('/api/test', { method: 'POST' });
        const j = await res.json();
        _valorAssert('fetch ok', res.ok === true && res.status === 200, 'status='+res.status);
        _valorAssert('fetch json contents', j.method === 'POST' && j.ok === true, JSON.stringify(j));
        // Restore
        window.fetch = origFetch;
      } catch (e) {
        _valorAssert('fetch-mock-exception', false, String(e && e.stack || e));
      }
    };
  </script>
</body>
</html>
