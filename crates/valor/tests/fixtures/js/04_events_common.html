<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Events Common (stopPropagation/preventDefault)</title>
  <style>
    html, body { margin: 0; padding: 0; }
    #outer { padding: 10px; background: #eee; }
    #inner { width: 120px; height: 40px; background: #cdf; }
    a { display: inline-block; padding: 4px 8px; background: #ffc; }
  </style>
</head>
<body>
  <div id="outer"><div id="inner"><a id="lnk" href="#x">link</a></div></div>
  <script>
    window._valorRun = function() {
      try {
        const log = [];
        function rec(s) { log.push(s); }
        const outer = document.getElementById('outer');
        const inner = document.getElementById('inner');
        const lnk = document.getElementById('lnk');
        outer.addEventListener('click', () => rec('bubble:outer'));
        inner.addEventListener('click', (e) => { rec('bubble:inner'); e.stopPropagation(); });
        // Dispatch on anchor, ensure outer does NOT receive due to stopPropagation on inner
        lnk.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
        _valorAssert('stopPropagation prevents outer bubble', log.indexOf('bubble:outer') === -1, log.join(','));
        _valorAssert('inner received click', log.indexOf('bubble:inner') !== -1, log.join(','));

        // preventDefault test on anchor
        let prevented = false;
        const ev = new MouseEvent('click', { bubbles: true, cancelable: true });
        lnk.addEventListener('click', (e) => e.preventDefault(), { once: true });
        const ok = lnk.dispatchEvent(ev);
        prevented = ev.defaultPrevented;
        _valorAssert('preventDefault marks defaultPrevented', prevented === true, 'defaultPrevented='+prevented);
        _valorAssert('dispatchEvent returns true when not canceled by listeners calling preventDefault? (spec returns false when canceled)', ok === !prevented, 'ok='+ok);
      } catch (e) {
        _valorAssert('events-common-exception', false, String(e && e.stack || e));
      }
    };
  </script>
</body>
</html>
