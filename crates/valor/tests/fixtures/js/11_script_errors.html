<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Script Errors</title>
  <style> html, body { margin:0; padding:0; } </style>
</head>
<body>
  <script>
    window._valorRun = async function() {
      try {
        let errorEventFired = false;
        let rejectionEventFired = false;
        window.addEventListener('error', function(ev){ errorEventFired = true; });
        window.addEventListener('unhandledrejection', function(ev){ rejectionEventFired = true; ev.preventDefault && ev.preventDefault(); });
        // sync throw captured by window.onerror path
        setTimeout(() => { throw new Error('boom'); }, 0);
        // unhandled promise rejection
        Promise.reject(new Error('reject-boom'));
        await new Promise(r => setTimeout(r, 20));
        _valorAssert('window.error fired', errorEventFired === true, 'errorEventFired='+errorEventFired);
        _valorAssert('unhandledrejection fired', rejectionEventFired === true, 'rejectionEventFired='+rejectionEventFired);
      } catch (e) {
        _valorAssert('script-errors-exception', false, String(e && e.stack || e));
      }
    };
  </script>
</body>
</html>
